name: Database Backup

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggers
    inputs:
      retention_days:
        description: 'Backup retention days'
        required: false
        default: '30'
        type: string

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client-16
      
      - name: Create Backup Directory
        run: mkdir -p backups
      
      - name: Create Database Backup
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          PG_HOST: ${{ secrets.PG_HOST || 'localhost' }}
          PG_PORT: ${{ secrets.PG_PORT || '5432' }}
          PG_USER: ${{ secrets.PG_USER || 'pennywise' }}
          PG_DATABASE: ${{ secrets.PG_DATABASE || 'pennywise' }}
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="pennywise_${TIMESTAMP}.sql.gz"
          
          echo "Creating backup: ${BACKUP_FILE}"
          pg_dump -h "${PG_HOST}" \
                  -p "${PG_PORT}" \
                  -U "${PG_USER}" \
                  "${PG_DATABASE}" | \
          gzip > "backups/${BACKUP_FILE}"
          
          # Verify backup was created
          if [ -f "backups/${BACKUP_FILE}" ]; then
            # Using ls -l for portability across different systems
            SIZE=$(ls -lh "backups/${BACKUP_FILE}" | awk '{print $5}')
            echo "Backup created successfully: ${BACKUP_FILE} (${SIZE})"
            echo "BACKUP_FILE=${BACKUP_FILE}" >> $GITHUB_ENV
          else
            echo "ERROR: Backup file was not created"
            exit 1
          fi
      
      - name: Upload Backup as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ github.run_number }}
          path: backups/*.sql.gz
          retention-days: ${{ inputs.retention_days || '30' }}
          compression-level: 0  # Files are already compressed
      
      - name: Backup Summary
        run: |
          echo "### Database Backup Summary :floppy_disk:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Backup File**: ${{ env.BACKUP_FILE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Database**: ${PG_DATABASE:-pennywise}" >> $GITHUB_STEP_SUMMARY
          echo "- **Retention**: ${{ inputs.retention_days || '30' }} days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Backup completed successfully!" >> $GITHUB_STEP_SUMMARY
